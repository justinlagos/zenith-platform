<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZENITH: Clinical Resonance v5.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- SWISS MEDICAL SYSTEM v5.0 --- */
        :root {
            --bg-base: #050505;
            --bg-panel: #0A0A0A;
            --border: rgba(255, 255, 255, 0.12);
            --border-hover: rgba(255, 255, 255, 0.3);
            --text-pri: #F0F2F5;
            --text-sec: #888899;
            --accent: #00A3FF; 
            --success: #34C759;
            --alert: #FF3B30;
            --radius: 4px;
        }

        [data-theme="light"] {
            --bg-base: #F5F7FA;
            --bg-panel: #FFFFFF;
            --border: rgba(0, 0, 0, 0.1);
            --border-hover: rgba(0, 0, 0, 0.2);
            --text-pri: #111111;
            --text-sec: #555566;
            --accent: #0066CC;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-base); color: var(--text-pri);
            font-family: 'Inter', sans-serif;
            overflow: hidden; height: 100vh; width: 100vw;
            transition: background 0.4s ease;
        }

        /* LAYOUT & VISIBILITY */
        #canvas-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.6; transition: opacity 1s; }
        
        /* VIEWS */
        .view { position: absolute; inset: 0; display: none; padding: 40px; overflow-y: auto; z-index: 10; opacity: 0; transition: opacity 0.5s ease; }
        .view.active { display: block; opacity: 1; }
        
        .container { max-width: 1200px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        .center-col { align-items: center; justify-content: center; text-align: center; }
        
        /* TYPOGRAPHY */
        .t-hero { font-size: 56px; font-weight: 500; letter-spacing: -0.04em; line-height: 1.1; margin-bottom: 24px; }
        .t-h2 { font-size: 24px; font-weight: 600; letter-spacing: -0.02em; margin-bottom: 12px; }
        .t-h3 { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-pri); }
        .t-mono { font-family: 'JetBrains Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-sec); display: block; margin-bottom: 8px; }
        .t-body { font-size: 15px; line-height: 1.6; color: var(--text-sec); margin-bottom: 24px; }
        .t-sm { font-size: 13px; line-height: 1.5; color: var(--text-sec); }
        .t-accent { color: var(--accent); }

        /* INTERACTIVE ELEMENTS */
        .btn {
            background: var(--text-pri); color: var(--bg-base);
            padding: 14px 28px; border: 1px solid var(--text-pri);
            font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 700;
            cursor: pointer; transition: 0.2s; border-radius: var(--radius);
            pointer-events: auto;
        }
        .btn:hover { background: var(--accent); border-color: var(--accent); color: white; transform: translateY(-1px); }
        
        .btn-ghost { background: transparent; color: var(--text-pri); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

        .card {
            border: 1px solid var(--border); background: var(--bg-panel);
            padding: 32px; transition: 0.2s; cursor: pointer; border-radius: var(--radius);
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 260px; pointer-events: auto;
        }
        .card:hover { border-color: var(--accent); transform: translateY(-4px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

        .input-field {
            background: transparent; border: none; border-bottom: 1px solid var(--border);
            color: var(--text-pri); font-size: 20px; padding: 12px 0; width: 100%;
            font-family: 'Inter', sans-serif; outline: none; margin-bottom: 24px; pointer-events: auto;
        }
        .input-field:focus { border-color: var(--accent); }

        /* GRID */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; width: 100%; }
        @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }

        /* HUD */
        #hud {
            position: fixed; inset: 0; z-index: 50; padding: 40px;
            display: none; flex-direction: column; justify-content: space-between;
            pointer-events: none;
        }
        #hud.active { display: flex; }
        .hud-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .metric-big { font-family: 'JetBrains Mono'; font-size: 64px; line-height: 1; font-weight: 300; }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box { width: 100%; max-width: 450px; text-align: center; }

        /* RESULTS */
        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; margin-top: 40px; }
        .insight-box { border-left: 3px solid var(--accent); padding-left: 24px; }
        .chart-bar { flex: 1; background: var(--accent); opacity: 0.3; transition: height 0.6s; border-radius: 2px 2px 0 0; }
        .chart-bar.filled { opacity: 1; }

        /* THEME BTN */
        .theme-btn {
            position: fixed; top: 32px; right: 32px; z-index: 100;
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
            color: var(--text-pri); display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto;
        }
        video { display: none; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <!-- EMAIL JS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>

    <div id="canvas-layer"></div>
    <video id="input_video" playsinline></video>
    <div class="theme-btn" onclick="Theme.toggle()"><i class="fas fa-adjust"></i></div>

    <!-- 1. LANDING -->
    <section id="v-landing" class="view active" style="z-index: 30;">
        <div class="container center-col">
            <div style="height: 10vh;"></div>
            <span class="t-mono t-accent">PRESCRIPTIVE DIGITAL THERAPEUTICS</span>
            <h1 class="t-hero">ZENITH v5.0</h1>
            <p class="t-body" style="max-width: 500px; margin: 24px auto;">
                A scientific interface for your nervous system. By translating biological signals into structured visualizations, we help you regulate anxiety, tremors, and focus drift.
            </p>
            <button class="btn" onclick="UI.showModal('modal-intake')">Initialize Session</button>
            
            <div class="grid-3" style="margin-top: 80px; text-align: left; padding-top: 40px; border-top: 1px solid var(--border);">
                <div>
                    <span class="t-mono t-accent">01 • CONNECT</span>
                    <h3 class="t-h3" style="margin-top:12px">BIOMETRIC SENSING</h3>
                    <p class="t-sm" style="margin-top:8px">Secure computer vision tracks fine motor control and autonomic jitter in real-time.</p>
                </div>
                <div>
                    <span class="t-mono t-accent">02 • VISUALIZE</span>
                    <h3 class="t-h3" style="margin-top:12px">NEURO-MIRRORING</h3>
                    <p class="t-sm" style="margin-top:8px">Internal states projected onto digital grids. Calm biology creates order; stress creates chaos.</p>
                </div>
                <div>
                    <span class="t-mono t-accent">03 • ANALYZE</span>
                    <h3 class="t-h3" style="margin-top:12px">PREDICTIVE HEALTH</h3>
                    <p class="t-sm" style="margin-top:8px">Receive clinical reports detailing stability improvements and signs of cognitive fatigue.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- MODAL: INTAKE -->
    <div id="modal-intake" class="modal-overlay">
        <div class="modal-box card">
            <span class="t-mono t-muted">PATIENT CHECK-IN</span>
            <div style="margin: 24px 0;">
                <input type="text" id="in-name" class="input-field" placeholder="Full Name" style="margin-bottom:12px;">
                <input type="email" id="in-email" class="input-field" placeholder="Email Address">
            </div>
            <p class="t-mono t-muted" style="text-align: left; margin-top: 20px; font-size:10px;">
                <i class="fas fa-lock"></i> PRIVACY: Processing is local. No biometrics stored.
            </p>
            <button class="btn" style="width:100%" onclick="App.submitIntake()">AUTHENTICATE</button>
        </div>
    </div>

    <!-- 2. TRIAGE -->
    <section id="v-triage" class="view">
        <div class="container center-col">
            <div class="center-text" style="margin-bottom: 40px;">
                <span class="t-mono t-accent">STEP 2 OF 3</span>
                <h2 class="t-h2">SELECT CLINICAL PROTOCOL</h2>
            </div>
            <div class="grid-3">
                <div class="card" onclick="App.selectProtocol('A')">
                    <div><span class="t-mono t-accent">2:44 MIN</span><h3 class="t-h3" style="margin-top:12px;">ANXIETY REGULATION</h3><p class="t-sm" style="margin-top:12px;">Uses fluid wave dynamics to lower heart rate and sympathetic arousal.</p></div><span class="t-mono t-muted">PROTOCOL A</span>
                </div>
                <div class="card" onclick="App.selectProtocol('B')">
                    <div><span class="t-mono t-accent">2:30 MIN</span><h3 class="t-h3" style="margin-top:12px;">MOTOR STABILITY</h3><p class="t-sm" style="margin-top:12px;">Orthopedic grid lines help visualize and correct hand tremors.</p></div><span class="t-mono t-muted">PROTOCOL B</span>
                </div>
                <div class="card" onclick="App.selectProtocol('C')">
                    <div><span class="t-mono t-accent">2:59 MIN</span><h3 class="t-h3" style="margin-top:12px;">ATTENTION SPAN</h3><p class="t-sm" style="margin-top:12px;">High-contrast radar tunnel trains you to maintain gaze steadiness.</p></div><span class="t-mono t-muted">PROTOCOL C</span>
                </div>
                <div class="card" onclick="App.selectProtocol('D')">
                    <div><span class="t-mono t-accent">2:15 MIN</span><h3 class="t-h3" style="margin-top:12px;">DYSPRAXIA COORD</h3><p class="t-sm" style="margin-top:12px;">Radial burst patterns to help with movement planning.</p></div><span class="t-mono t-muted">PROTOCOL D</span>
                </div>
                <div class="card" onclick="App.selectProtocol('E')">
                    <div><span class="t-mono t-accent">2:44 MIN</span><h3 class="t-h3" style="margin-top:12px;">SENSORY REG</h3><p class="t-sm" style="margin-top:12px;">Low-stimulus flow field for nervous system grounding.</p></div><span class="t-mono t-muted">PROTOCOL E</span>
                </div>
                <div class="card" onclick="App.selectProtocol('F')">
                    <div><span class="t-mono t-accent">2:20 MIN</span><h3 class="t-h3" style="margin-top:12px;">BURNOUT RESET</h3><p class="t-sm" style="margin-top:12px;">Cognitive visual resetting to clear mental fatigue.</p></div><span class="t-mono t-muted">PROTOCOL F</span>
                </div>
            </div>
            <div class="center-text" style="margin-top:40px;">
                <button class="btn-ghost" onclick="UI.switch('v-landing')">← BACK</button>
            </div>
        </div>
    </section>

    <!-- CALIBRATION MODAL -->
    <div id="modal-calib" class="modal-overlay">
        <div class="modal-box card" style="background: rgba(0,0,0,0.8); max-width:400px; text-align:center;">
            <span class="t-mono t-accent">SENSOR CALIBRATION</span>
            <div class="t-hero" id="calib-count" style="font-size: 80px; margin: 20px 0;">5</div>
            <span class="t-mono t-muted">HOLD HAND STEADY</span>
        </div>
    </div>

    <!-- 3. SESSION HUD -->
    <div id="hud">
        <div class="hud-row">
            <div>
                <span class="t-mono t-accent" id="hud-pid">PROTOCOL</span>
                <div class="t-h2" id="hud-name">NAME</div>
            </div>
            <div style="text-align: right;">
                <span class="metric-big" id="hud-time">00:00</span>
                <span class="t-mono t-muted" style="display:block">REMAINING</span>
            </div>
        </div>
        <div class="hud-row">
            <div>
                <span class="t-mono t-muted">INSTRUCTION</span>
                <div class="t-h3 t-accent" id="hud-advice">...</div>
            </div>
            <div style="text-align: right;">
                <span class="metric-big" id="hud-val">--</span>
                <span class="t-mono t-muted" style="display:block">STABILITY INDEX</span>
            </div>
        </div>
    </div>

    <!-- 4. DEBRIEF -->
    <section id="v-debrief" class="view">
        <div class="container">
            <div class="center-text" style="margin-bottom: 40px;">
                <span class="t-mono t-success">SESSION COMPLETE</span>
                <h2 class="t-h2">INTELLIGENCE REPORT</h2>
            </div>
            <div class="dash-grid">
                <div>
                    <div class="card" style="border-left: 4px solid var(--accent);">
                        <span class="t-mono t-muted">CLINICAL OBSERVATION</span>
                        <p class="t-body" style="font-size: 18px; color: var(--text-pri); margin-top: 10px;" id="res-text">Processing...</p>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 16px; border-radius: var(--radius);">
                            <span class="t-mono t-accent">WHY THIS MATTERS</span>
                            <p class="t-sm" style="margin-top:8px;" id="res-explain">...</p>
                        </div>
                    </div>
                    <div style="margin-top:24px; padding:20px; border:1px solid var(--border); border-radius: var(--radius);">
                        <span class="t-mono t-muted">REPORT STATUS</span>
                        <p class="t-sm" style="margin-top:4px;">Report sent to: <span id="res-email" style="color:var(--text-pri)"></span> <span id="mail-status" style="margin-left:10px;">(Sending...)</span></p>
                    </div>
                </div>
                <div>
                    <div class="card" style="height: 100%; justify-content:flex-end;">
                        <span class="t-mono t-muted">NET IMPROVEMENT</span>
                        <span class="metric-big t-accent" id="res-score">+0%</span>
                        <div style="height: 100px; display:flex; align-items:flex-end; gap:4px; margin-top:24px;" id="res-chart"></div>
                        <span class="t-mono t-muted" style="margin-top:10px; display:block;">STABILITY OVER TIME</span>
                    </div>
                </div>
            </div>
            <div class="center-text" style="margin-top: 60px;">
                <button class="btn-ghost" onclick="window.location.reload()">RETURN TO MENU</button>
            </div>
        </div>
    </section>

    <script>
        // --- 1. EMAIL CONFIGURATION ---
        (function(){
            // Public Key
            emailjs.init("KHTzvT8_pB_9tNoQE"); 
        })();

        // --- 2. CONFIGURATION ---
        const CONFIG = {
            'A': { 
                name: 'ANXIETY REGULATION', time: 164, mode: 'WAVE', label: 'VAGAL STABILITY', 
                advice: 'Sync breathing with the waves.',
                desc: 'Measures reduction in autonomic jitter (micro-tremors). High scores indicate a successful shift to "Rest and Digest" state.'
            },
            'B': { 
                name: 'NEURO-MOTOR CALIB', time: 150, mode: 'GRID', label: 'KINEMATIC SMOOTHNESS', 
                advice: 'Move slowly across the grid.',
                desc: 'Represents movement smoothness. Improvement suggests better motor cortex signal firing and reduced tremor artifacts.'
            },
            'C': { 
                name: 'ATTENTION LOCK', time: 179, mode: 'TUNNEL', label: 'FOCUS STAMINA', 
                advice: 'Keep hand in center.',
                desc: 'Tracks centered attention sustainability. High scores correlate with improved working memory and executive function.'
            },
            'D': { 
                name: 'DYSPRAXIA COORD', time: 135, mode: 'RADIAL', label: 'PATH ACCURACY', 
                advice: 'Trace the lines outward.',
                desc: 'Measures ability to move in straight lines without deviation. Strengthening these pathways helps with fine motor skills.'
            },
            'E': { 
                name: 'SENSORY REG', time: 164, mode: 'WAVE', label: 'SENSORY LOAD', 
                advice: 'Relax gaze. Follow the flow.',
                desc: 'Visuals simplified to reduce cognitive load. Improvement suggests effective self-regulation of sensory input.'
            },
            'F': { 
                name: 'BURNOUT RESET', time: 140, mode: 'TUNNEL', label: 'COGNITIVE CLEARANCE', 
                advice: 'Let thoughts drift.',
                desc: 'Uses "visual wiping" to clear working memory fatigue. Positive scores suggest a reduction in cognitive resistance.'
            }
        };

        const State = { user:{name:'',email:''}, protocol:null, active:false, calibration:0.5, history:[] };

        // --- 3. SENTINEL INTELLIGENCE ---
        const Sentinel = {
            analyze: (data) => {
                const n = data.length;
                const win = Math.floor(n * 0.1) || 5;
                const start = data.slice(0, win).reduce((a,b)=>a+b,0)/win || 0.5;
                const end = data.slice(-win).reduce((a,b)=>a+b,0)/win || 0.5;
                let delta = ((end - start) / start) * 100;
                
                // Narrative Gen
                let obs = "";
                let risk = "LOW";
                if(delta > 10) obs = "Significant stabilization detected. Your nervous system regulated effectively.";
                else if(end < start - 0.1) {
                    obs = "Signs of fatigue detected. You started strong but stability decreased.";
                    risk = "MODERATE";
                }
                else obs = "Performance remained stable. Consistent baseline maintenance.";

                return { start, end, score: Math.floor(delta), text: obs, risk };
            }
        };

        // --- 4. MAILER (UPDATED PARAMS) ---
        const Mailer = {
            send: (result) => {
                const statusEl = document.getElementById('mail-status');
                
                const serviceID = "service_wpwe6kc"; 
                const templateID = "template_d8oxo67";

                const params = {
                    to_name: State.user.name,
                    to_email: State.user.email,
                    protocol: CONFIG[State.protocol].name,
                    score: (result.score>0?'+':'')+result.score+'%',
                    // Clinical Table Data
                    start_val: result.start.toFixed(2),
                    end_val: result.end.toFixed(2),
                    risk_label: result.risk,
                    insight: result.text,
                    date: new Date().toLocaleDateString()
                };

                emailjs.send(serviceID, templateID, params)
                    .then(() => {
                        statusEl.innerText = "(Sent Successfully)";
                        statusEl.style.color = "var(--success)";
                    })
                    .catch((err) => {
                        console.warn('Email check:', err);
                        statusEl.innerText = "(Error - Check IDs)"; 
                        statusEl.style.color = "var(--alert)"; 
                    });
            }
        };

        // --- 5. VISUAL ENGINE ---
        const Visuals = {
            scene: null, cam: null, ren: null, mesh: null,
            uniforms: { uTime: {value:0}, uStress: {value:0}, uColor: {value:new THREE.Color(0x00A3FF)} },
            
            init: () => {
                Visuals.scene = new THREE.Scene();
                Visuals.scene.fog = new THREE.FogExp2(0x050505, 0.002);
                Visuals.cam = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
                Visuals.cam.position.set(0, 10, 40);
                Visuals.cam.lookAt(0,0,0);
                Visuals.ren = new THREE.WebGLRenderer({antialias:true, alpha:true});
                Visuals.ren.setSize(innerWidth, innerHeight);
                Visuals.ren.setPixelRatio(Math.min(devicePixelRatio, 1.5));
                document.getElementById('canvas-layer').appendChild(Visuals.ren.domElement);
                
                // Texture Gen
                const canvas = document.createElement('canvas'); canvas.width=32; canvas.height=32;
                const ctx = canvas.getContext('2d');
                const g = ctx.createRadialGradient(16,16,0,16,16,16);
                g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(255,255,255,0)');
                ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
                const tex = new THREE.CanvasTexture(canvas);

                const count = 15000;
                const geo = new THREE.InstancedBufferGeometry();
                geo.copy(new THREE.PlaneBufferGeometry(0.3, 0.3));
                const pos = new Float32Array(count*3);
                for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*150;
                geo.setAttribute('aOffset', new THREE.InstancedBufferAttribute(pos,3));
                geo.setAttribute('aIdx', new THREE.InstancedBufferAttribute(new Float32Array(count).map((_,i)=>i),1));

                const mat = new THREE.ShaderMaterial({
                    uniforms: { ...Visuals.uniforms, uTex: {value:tex} },
                    transparent: true, depthWrite: false, blending: THREE.AdditiveBlending,
                    defines: { MODE_WAVE: '' },
                    vertexShader: `
                        uniform float uTime; uniform float uStress;
                        attribute vec3 aOffset; attribute float aIdx;
                        varying float vAlpha;
                        void main() {
                            vec3 p = aOffset;
                            #ifdef MODE_WAVE
                                float y = sin(p.x*0.1 + uTime)*3.0 + cos(p.z*0.1 + uTime*0.5)*3.0;
                                p.y = y + (fract(sin(aIdx)*43.54)-0.5)*uStress*10.0;
                            #endif
                            #ifdef MODE_GRID
                                p.x = floor(p.x/2.0)*2.0; p.z = floor(p.z/2.0)*2.0;
                                p.y = sin(p.x*0.5)*cos(p.z*0.5 + uTime*5.0) * uStress * 15.0;
                            #endif
                            #ifdef MODE_TUNNEL
                                float a = aIdx*0.1; float r = 10.0 + mod(aIdx, 5.0) * 5.0;
                                p.x = cos(a)*r; p.y = sin(a)*r;
                                p.z = mod(aOffset.z + uTime*30.0, 100.0) - 50.0;
                                if(uStress > 0.3) p.xy *= 1.0 + sin(p.z*0.2)*uStress;
                            #endif
                            #ifdef MODE_RADIAL
                                float ang = (aIdx/15000.0)*6.28*20.0; float rad = mod(aIdx, 60.0);
                                p.x = cos(ang)*rad; p.y = sin(ang)*rad; p.z=0.0;
                                if(uStress>0.2) p.x += (fract(sin(aIdx))-0.5);
                            #endif
                            vec4 mv = modelViewMatrix * vec4(p,1.0);
                            gl_Position = projectionMatrix * mv;
                            gl_PointSize = (400.0 / -mv.z);
                            vAlpha = 1.0 - (length(p)/80.0);
                        }
                    `,
                    fragmentShader: `
                        uniform vec3 uColor; uniform sampler2D uTex; varying float vAlpha;
                        void main() { gl_FragColor = vec4(uColor, vAlpha) * texture2D(uTex, gl_PointCoord); }
                    `
                });
                
                Visuals.mesh = new THREE.Mesh(geo, mat);
                Visuals.scene.add(Visuals.mesh);
                Visuals.loop();
            },
            setMode: (mode) => {
                if(!Visuals.mesh) return;
                const m = Visuals.mesh.material;
                m.defines = {};
                m.defines[`MODE_${mode}`] = '';
                m.needsUpdate = true;
            },
            loop: () => {
                requestAnimationFrame(Visuals.loop);
                if(State.active || document.getElementById('v-landing').style.display === 'block') {
                    Visuals.uniforms.uTime.value = performance.now()*0.001;
                    Visuals.uniforms.uStress.value = Vision.val;
                    Visuals.ren.render(Visuals.scene, Visuals.cam);
                }
            }
        };

        // --- VISION ---
        const Vision = {
            val: 0, last: {x:0, y:0},
            init: () => {
                const h = new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
                h.setOptions({maxNumHands:1, modelComplexity:0});
                h.onResults(res => {
                    if(res.multiHandLandmarks.length>0) {
                        const w = res.multiHandLandmarks[0][0];
                        const d = Math.hypot(w.x-Vision.last.x, w.y-Vision.last.y);
                        Vision.val = (Vision.val*0.9) + (d*80*0.1);
                        Vision.last = {x:w.x, y:w.y};
                    } else Vision.val *= 0.95;
                });
                const c = new Camera(document.getElementById('input_video'), {
                    onFrame: async()=>await h.send({image:document.getElementById('input_video')}), width:640, height:480
                });
                c.start();
                Visuals.init();
            }
        };

        // --- APP FLOW ---
        const App = {
            submitIntake: () => {
                const n = document.getElementById('in-name');
                const e = document.getElementById('in-email');
                if(!n.value) return;
                State.user = {name:n.value, email:e.value};
                UI.closeModal('modal-intake');
                UI.switch('v-triage');
                Vision.init(); 
            },
            selectProtocol: (pid) => {
                State.protocol = pid;
                UI.showModal('modal-calib');
                let t = 5;
                const int = setInterval(()=>{
                    t--; document.getElementById('calib-count').innerText=t;
                    if(t<=0){
                        clearInterval(int);
                        State.calibration = Math.max(0.1, Vision.val);
                        UI.closeModal('modal-calib');
                        App.run(pid);
                    }
                },1000);
            },
            run: (pid) => {
                const c = CONFIG[pid];
                document.getElementById('hud-name').innerText = c.name;
                document.getElementById('hud-pid').innerText = `PROTOCOL ${pid}`;
                document.getElementById('hud-advice').innerText = c.advice;
                document.getElementById('hud-label').innerText = c.label;
                
                Visuals.setMode(c.mode);
                State.active = true;
                State.history = [];
                
                UI.switch('null'); 
                document.getElementById('hud').classList.add('active');
                
                let dur = c.time;
                App.timer = setInterval(()=>{
                    dur--;
                    const m=Math.floor(dur/60), s=(dur%60).toString().padStart(2,'0');
                    document.getElementById('hud-time').innerText = `0${m}:${s}`;
                    
                    const stability = Math.max(0, 1 - (Vision.val / (State.calibration*3)));
                    State.history.push(stability);
                    document.getElementById('hud-val').innerText = Math.floor(stability*100) + '%';

                    if(dur<=0) App.end();
                },1000);
            },
            end: () => {
                clearInterval(App.timer);
                State.active = false;
                document.getElementById('hud').classList.remove('active');
                
                const res = Sentinel.analyze(State.history);
                const conf = CONFIG[State.protocol];
                
                document.getElementById('res-score').innerText = (res.score>0?'+':'')+Math.floor(res.score)+'%';
                document.getElementById('res-text').innerText = res.text;
                document.getElementById('res-explain').innerText = conf.desc;
                document.getElementById('res-email').innerText = State.user.email;

                // TRIGGER EMAIL
                Mailer.send(res);

                // Chart
                const chart = document.getElementById('res-chart');
                chart.innerHTML = '';
                const step = Math.floor(res.data?res.data.length/20:State.history.length/20)||1;
                const source = State.history;
                for(let i=0; i<20; i++){
                    const v = source[i*step]||0.5;
                    const d = document.createElement('div');
                    d.className = 'chart-bar';
                    d.style.height = (v*100)+'%';
                    chart.appendChild(d);
                    setTimeout(()=>d.classList.add('filled'), i*50);
                }

                UI.switch('v-debrief');
            }
        };

        const Theme = {
            toggle: () => {
                const el = document.documentElement;
                const light = el.getAttribute('data-theme')==='light';
                el.setAttribute('data-theme', light ? 'dark' : 'light');
                const c = light ? 0x00A3FF : 0x0066CC;
                const f = light ? 0x050505 : 0xF5F7FA;
                if(Visuals.uniforms) Visuals.uniforms.uColor.value.setHex(c);
                if(Visuals.scene) Visuals.scene.fog.color.setHex(f);
            }
        };

        const UI = {
            switch: (id) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                if(id!=='null') {
                    const el = document.getElementById(id);
                    el.style.display = 'block'; 
                    setTimeout(()=>el.classList.add('active'), 10);
                }
                document.getElementById('canvas-layer').style.opacity = (id==='null') ? 1 : 0.3;
            },
            showModal: (id) => document.getElementById(id).classList.add('active'),
            closeModal: (id) => document.getElementById(id).classList.remove('active')
        };

        Visuals.init();

    </script>
</body>
</html>
